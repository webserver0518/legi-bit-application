name: Build and Push Docker Images

on:
  push:
    branches:
      - main

jobs:
  # Step 1: Detect Changes (Path Filtering)
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # Expose filter outputs for the next job
      backend: ${{ steps.filter.outputs.backend }} # true if changes detected in 'flask/' directory
      web: ${{ steps.filter.outputs.web }} # true if changes detected in 'nginx/' directory
      mongodb: ${{ steps.filter.outputs.mongodb }} # true if changes detected in 'services/mongodb/' directory
      s3: ${{ steps.filter.outputs.s3 }} # true if changes detected in 'services/s3/' directory
      ses: ${{ steps.filter.outputs.ses }} # true if changes detected in 'services/ses/' directory
    steps:
      - uses: actions/checkout@v3 # clone the repo

      - uses: dorny/paths-filter@v2 # path filtering action
        id: filter # step ID to reference outputs
        with:
          filters: |
            backend:
              - 'flask/**'
            web:
              - 'nginx/**'
            mongodb:
              - 'services/mongodb/**'
            s3:
              - 'services/s3/**'
            ses:
              - 'services/ses/**'

  # Step 2: Build and Push Images (Matrix Strategy)
  build-and-push:
    needs: detect-changes # depend on the previous job
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # If one job fails, do not cancel the others
      matrix:
        include:
          - service: backend
            context: ./flask
            image_name: legi-bit-flask
          - service: web
            context: ./nginx
            image_name: legi-bit-nginx
          - service: mongodb
            context: ./services/mongodb
            image_name: legi-bit-mongodb
          - service: s3
            context: ./services/s3
            image_name: legi-bit-s3
          - service: ses
            context: ./services/ses
            image_name: legi-bit-ses

    # Conditional Execution: Run only if the specific service has changed
    # Using dynamic key access to check the relevant output

    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        if: ${{ needs.detect-changes.outputs[matrix.service] == 'true' }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push ${{ matrix.service }}
        if: ${{ needs.detect-changes.outputs[matrix.service] == 'true' }}
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.context }}
          push: true
          tags: webserver0518/${{ matrix.image_name }}:v${{ github.run_number }}
